server {
    listen 80;
    server_name localhost;

    # 1. Rutas de API: Proxy Pass a los Microservicios
    # =========================================================================

    # Bloque de proxy para el Microservicio CURSOS (Spring Boot - 172.28.0.40:8090)
    # RUTA EXTERNA SIN COLISIÓN: /servicio_cursos/...
    location ^~ /servicio_cursos {
        # Nginx reescribe: '/servicio_cursos/health' se convierte en 'http://cursos:8090/api/health'
        proxy_pass http://cursos:8090/api; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Bloque de proxy para el Microservicio MENSAJES (Flask - 172.28.0.20:5000)
    # RUTA EXTERNA SIN COLISIÓN: /servicio_mensajes/...
    location ^~ /servicio_mensajes {
        # Nginx reescribe: '/servicio_mensajes/store' se convierte en 'http://mensajes:5000/api/store'
        proxy_pass http://mensajes:5000/api; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Bloque de proxy para el API Gateway SEGURIDAD (Laravel)
    # Esta ruta genérica /api/ SOLO capturará peticiones que Laravel debe manejar
    # y que NO iniciaron con /servicio_cursos o /servicio_mensajes.
    location /api/ {
        fastcgi_pass seguridad:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        include fastcgi_params;
    }

    # 2. Rutas del Frontend: Proxy al contenedor Nginx del Frontend
    # =========================================================================
    
    # Ruta raíz (/) y cualquier otra ruta que no sea API
    location / {
        proxy_pass http://frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 3. Restricciones de Acceso
    # =========================================================================

    location ~ /\. {
        deny all;
    }
}