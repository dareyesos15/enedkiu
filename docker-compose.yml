services:
  # =========================================================
  # 1. API GATEWAY (LARAVEL - PHP-FPM)
  # =========================================================
  seguridad:
    build:
      context: ./seguridad
      dockerfile: Dockerfile.seguridad
    container_name: api_gateway_seguridad
    restart: unless-stopped
    volumes:
      - ./seguridad:/var/www/html
      - /var/www/html/vendor
    networks:
      network_services:
        # IPv4 Estático ELIMINADO para solucionar problemas de DNS
    depends_on:
      - mysql_seguridad
      
  # ---------------------------------------------------------
  # 2. MICROSERVICIO MENSAJES (FLASK - PYTHON)
  # ---------------------------------------------------------
  mensajes:
    build:
      context: ./mensajes
      dockerfile: Dockerfile.mensajes
    container_name: microservicio_mensajes
    restart: unless-stopped
    volumes:
      - ./mensajes:/usr/src/app
    networks:
      network_services:
        # IPv4 Estático ELIMINADO para solucionar problemas de DNS
    depends_on:
      - mongodb_mensajes

  # ---------------------------------------------------------
  # 3. MICROSERVICIO FRONTEND (REACT/VITE - NODE.JS)
  # ---------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend
    container_name: microservicio_frontend
    restart: unless-stopped
    networks:
      network_services:
        # IPv4 Estático ELIMINADO para solucionar problemas de DNS
    
  # ---------------------------------------------------------
  # 4. MICROSERVICIO CURSOS (SPRING BOOT - JAVA)
  # ---------------------------------------------------------
  cursos:
    build:
      context: ./cursos
      dockerfile: Dockerfile.cursos
    container_name: microservicio_cursos
    restart: unless-stopped
    # Nota: No necesitamos un volumen bind-mount aquí en producción porque la imagen
    # ya contiene el código compilado (JAR).
    networks:
      network_services:
        # IPv4 Estático ELIMINADO para solucionar problemas de DNS
    depends_on:
      - mysql_cursos
      
  # ---------------------------------------------------------
  # 5. Servidor web Nginx (API GATEWAY / PROXY INVERSO)
  # ---------------------------------------------------------
  nginx:
    image: nginx:stable-alpine
    container_name: api_gateway_nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./seguridad:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - network_services
    depends_on:
      - seguridad
      - mensajes
      - frontend 
      - cursos # Nueva dependencia para el proxy

  # =========================================================
  # 6. BASES DE DATOS
  # =========================================================
  
  # Base de datos MySQL para 'seguridad'
  mysql_seguridad:
    image: mysql:8.0
    container_name: db_mysql_seguridad
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: seguridad
      MYSQL_USER: user 
      MYSQL_PASSWORD: user 
      MYSQL_ROOT_PASSWORD: root
      TZ: America/Bogota
    volumes:
      - dbdata_seguridad:/var/lib/mysql
    networks:
      - network_services

  # Base de datos MongoDB para 'mensajes'
  mongodb_mensajes:
    image: mongo:latest
    container_name: db_mongodb_mensajes
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: mensajes 
    volumes:
      - dbdata_mensajes:/data/db
    networks:
      - network_services

  # Base de datos MySQL para 'cursos'
  mysql_cursos:
    image: mysql:8.0
    container_name: db_mysql_cursos
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: cursos
      MYSQL_USER: user 
      MYSQL_PASSWORD: user 
      MYSQL_ROOT_PASSWORD: root
      TZ: America/Bogota
    volumes:
      - dbdata_cursos:/var/lib/mysql
    networks:
      - network_services

# =========================================================
# VOLÚMENES Y REDES
# =========================================================
volumes:
  dbdata_seguridad:
  dbdata_mensajes:
  dbdata_cursos: # Nuevo volumen para la DB de cursos

networks:
  network_services:
    driver: bridge
    # Bloque IPAM ELIMINADO para usar el DNS dinámico de Docker